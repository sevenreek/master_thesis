\section{Research setup}
An FPGA powered data acquisition board was used as the platform 
for the hardware implementation of digital pulse processing of PMT
signals.
The following subsections describe the system component in detail and
\autoref{fig:system_overview} shows an overview of the testbench.
\subsection{PMT}
\subsection{Preamplifier}
\subsection{Digitizer board}
To acquire and digitize the signals produced by the PMT and preamplifier
combination Teledyne SP Devices ADQ14-4C was used. The board was connected
through PCIe 2.0 to the host PC running custom acquisition software.
ADQ14-4C can sample signals from up to 4 channels, each at a maximum
frequency of 1 GHz. 
\begin{table}[H]
\caption{Chosen parameters of ADQ14-4C}
\centering
  \begin{tabular}{l l}
    material  & T [K]\\
    \hline
    Sn                     & 3,7 \\
    Pb                     & 7,2 \\
    Al                     & 1,2\\
  \end{tabular}
  \label{tab:adq14_datasheet}
\end{table}


The ADQ14 acquires samples with a 14-bit ADC.
The device applies factory calibrated digital gain and shift
to the raw measurements, 
so in order to maintain higher precision the samples are 
extended to 16 bits representing two full bytes. 
The additional two bits represent the fractional part potentially
produced by the fractional gain component.


The ADQ14 can operate in both triggered streaming and continuous mode.
In continuous mode samples are constantly gathered and periodically
transferred to the host PC. In triggered streaming a window of samples is 
collected only after a trigger event is detected. This is a basic feature
that allows for some data reduction, as only events of interest have to
be transferred to the host PC. Multiple triggering mechanisms, 
like level, periodic and external are available.


In all modes of operation the device relies on an internal 2 GB DRAM
to act as a FIFO queue for the generated records.
The device relies on Direct Memory Access (DMA) to transfer
data to the host PC. This is a special mode of operation for 
peripheral devices in which a chunk of the computer's memory is
made available to them without the need of CPU brokerage.


Unfortunately the maximum size of DMA buffers is limited. 
With a sampling speed of a 1 GHz and 2 byte samples up 
to two gigabytes of data can be generated each second for each
channel that is active. Even with reliance on DMA maintaining 
a transfer speed this high is problematic. To solve this issue, 
the ADQ14's internal DRAM acts as a buffer 
whenever the throughput becomes too high.
Records are first stored in the internal DRAM and periodically
transferred to the host PC's RAM whenever buffers become ready.
At maximum speed a single channel can, however, still fill the entirety
of this buffer in just a second if its contents are not processed in time.

\subsubsection{Open FPGA design} \label{ssec:adq_devkit}

A crucial feature of ADQ14 is the fact that its core processing
functionality is realised with the use of an on-board FPGA,
more specificaly a Xilinx Kintex 7 K325T. The design of the FPGA
is partially open. Users can implement custom
filtering or data analysis on samples in real time.
This fact is used to implement the custom pulse processing described in this work.


The firmware is unfortunately not entirely open-source.
Third-party IP cores cannot be distributed to end customers 
and thus user algorithms are limited to two sections called User Logics.
User Logic 1 is a core placed after the ADC samples are subjected to factory
gain, but before the signals are passed on to trigger control.
This enables the implementation of custom triggering logic.


User Logic 2 is intended to house more complicated logic.
This module has access to the GPIO ports and some metadata
outputs, that can be used to better describe the transferred records.
User Logic 2 is located right before the encrypted packet generator
that is responsible for queueing the incoming data in ADQ14's DRAM 
for transfer to the host PC. The packet generator can be partially
controlled from within User Logic 2. Arbitrary data can be injected
in place of the samples for each channel and the size of transferred windows 
can be modified.

\subsubsection{Parallel sampling}

The FPGA is clocked only at 250 MHz which is exactly a quarter of 
the ADC maximum operating frequency. This means that each channel
of the digitizer outputs 4 samples on each clock cycle of the 
FPGA. This is a necessary design choice as FPGAs fare better 
at lower clock speeds due to the need of less complex routing
when it comes to connecting the various peripherals and CLBs.


Such design does however complicate the implementation of 
Digital Signal Processing. It is especially cumbersome for 
functions that depend on delayed samples.
Accumulators have the need of summing up 4 samples on
each clock cycle instead of one. Complicated operations
like multiplication and division require duplicated logic.
Most functionality must be properly pipelined to avoid
timing issues in the FPGA design.

\subsection{Host computer}
\subsection{Software package}
To control the acquisition process and handle the data transfer,
a custom software GUI application was developed. The application
employs an API provided by SP Devices to interface to the digitizer board.
The Qt5 framework is used for GUI display and multiple other functions.
The application leverages the Qt's signal/slot system heavily to synchronize
threaded events.


The primary thread of the software application
is used for UI display and general tasks like 
loading and saving configurations. A secondary thread
is spawned to control data acquisition and archival.
The proper operation of the secondary worker thread
is crucial in obtaining a high data throughput and 
the process of software optimization is described in 
\autoref{sec:data_transfer}
