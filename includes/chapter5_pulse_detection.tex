\section{Pulse detection}
In order to process any pulses they must be first detected. 
The window of interest containing a pulse to be analysed
must be properly distinguished from the surrounding noise.
Although detection is a must, it also brings the added benefit
of data rate reduction. If pulses can be accurately 
marked within a signal it is possible to transfer only
those samples that compose the events to the host PC. 


The ADQ14 is capable of sampling signals with a frequency of
up to 1 GHz. With two bytes per sample, a single channel 
generates 2 GBs of raw data per second. For the PCIe 2.0 interface,
that is used in this work, the manufacturer's 
datasheet specifies a theoretical maximum throughput of 3.2 GB/s.
Even if this perfect limit could be obtained it would not allow 
for two channels to be active at once.
Using pulse detection for data reduction is thus unavoidable.
It is crucial to use a robust algorithm for this process to ensure 
that almost no pulses go unnoticed and near to none
false positives are transmitted.

\subsection{Level trigger}
The most basic approach to detection is a level trigger,
a technology available in virtually any spectroscope. As shown in 
\autoref{fig:level_trigger}, a trigger occurs when
the input signal crosses a predefined voltage level,
either on a rising or a falling edge. The point at which
this happens marks the beginning of a record window.
In the simplest case the end of a window is placed
a fixed duration from the start. Samples within that window
form a region of interest and are transferred further
down the processing pipeline.
\begin{figure}[H]
  \centering
  \includegraphics[width=.6\linewidth]{media/level_trigger.png}
  \caption{Level trigger}
  \label{fig:level_trigger}
\end{figure}


Once a window finishes, no more events are detected
until the signal returns to a value below the trigger level
(for rising edge triggering). This reset value might be 
set to be equal to the trigger level, however such approach
might lead to a scenario shown in \autoref{fig:lt_no_hysteresis}.
In a noisy environment the signal might falsely trigger immediately after
a window ends due to a random high spike on the slower falling edge of
an exponential pulse.
\begin{figure}[H]
  \centering
  \includegraphics[width=.6\linewidth]{media/lt_no_hysteresis.png}
  \caption{Level trigger with no hysteresis}
  \label{fig:lt_no_hysteresis}
\end{figure}

To prevent such false triggers typically some form of a hysteresis is used.
The reset level is shifted downwards, so that the input signal must cross
such a threshold that the random noise is almost guaranteed to never cause false 
triggers. \autoref{fig:lt_hysteresis} shows a hysteresis mitigating some false triggers.
Some of the false triggers from \autoref{fig:lt_no_hysteresis} are removed, however 
due to the high noise some still persist.
\begin{figure}[H]
  \centering
  \includegraphics[width=.6\linewidth]{media/lt_hysteresis.png}
  \caption{Level trigger with a hysteresis}
  \label{fig:lt_hysteresis} 
\end{figure}

With the slow falling edge of a pulse care must be taken not to 
overestimate the hysteresis. By setting the reset level too far away
from the trigger level pile-ups can be missed as pointed to in
\autoref{fig:lt_hysteresis_miss}. With a properly set hysteresis
the level trigger offers performance that is sufficient in most applications,
as suggested by its prevalence in modern spectroscopes.
In a tokamak's environment, however, the hysteresis
alone could potentially prove insufficient due to 
electromagnetic and temperature fluctuations having an effect on noise.
\begin{figure}[H]
  \centering
  \includegraphics[width=.6\linewidth]{media/lt_hysteresis_miss.png}
  \caption{Level trigger hysteresis causing missed events}
  \label{fig:lt_hysteresis_miss} 
\end{figure}
\subsection{Boxcar filter}

The two problems most apparent to simple level triggering 
are its susceptibility to noise and pulse overlap.
Just as with analogue approaches these two problems 
can be minimized with low-pass and high-pass filtering.
By utilizing a low-pass filter the input signal becomes 
smoother and more averaged, reducing the possibility of 
false triggers caused by random spikes. A high-pass filter
would reduce the DC component of the falling edge of a pulse,
making pile-ups easier to detect.


In the digital domain the simplest filters that perform
these operations are the Moving Average (MA) filter and 
the derivative filter. MA works to reduce the spikes and increase 
SNR. The derivative filter can strip the DC component from
a signal, meaning that the sharp rising edges will become
more attenuated in comparison to the decaying tails.


By combining the concepts of the MA and derivative filters
into a single a Boxcar filter is obtained. 
\autoref{fig:boxcar_effect} shows an example Boxcar transfer function,
together with its effect on an input signal of two exponential pulses.
The boxcar filter can be considered
to be a subtraction of two samples averaged with a window
of length $W$ delayed from each other by $W$. 
On \autoref{fig:boxcar_effect} $W=25$.
\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{media/boxcar_effect.png}
  \caption{Effect of boxcar filtering on two exponential pulses}
  \label{fig:boxcar_effect} 
\end{figure}

With basic level triggering
on the raw pulses the trigger position will be the later in a pulse the 
shorter it is. Pulses that reach just slightly above the trigger level
will be detected near their top, while pulses significantly stronger
than the trigger level will be detected near their start as shown in 
\autoref{fig:amplitude_walk}. This behaviour is called amplitude walk.

\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{media/amplitude_walk.png}
  \caption{Amplitude walk}
  \label{fig:amplitude_walk} 
\end{figure}


The derivative part of the Boxcar filter can be used in a
digital Constant Fraction Discriminator (CFD).
The point at which a pulse's derivative crosses zero after 
the sharp rise marks the peak of the original pulse. 
When using averaging from the boxcar filter this position 
will be slightly shifted but can still be reliably used to increase
the timestamping precision.

\subsection{Trapezoidal filter}
The trapezoidal filter shapes incoming pulses into the 
shape of an isosceles trapezoid. The sharp rising edge and 
slow decay tail are replaced with same length mirrored edges.
Instead of a sharp peak a flattop region is formed that is proportional
to the pulse height. The length of edges and the flattop can be freely
controlled through constants in the filter. \autoref{fig:trapezoid_effect}
shows the effect of a trapezoidal filter being applied to a train
of two exponential pulses. Note the dotted trigger line almost 
causing a false negative if applied to raw signal. 
The filtered signal provides a clear distinction 
between the slightly overlapping pulses.

\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{media/trapezoid_effect.png}
  \caption{Trapezoid filter applied to a train of two pulses}
  \label{fig:trapezoid_effect} 
\end{figure}


The trapezoidal filter is a more compllicated filter than the boxcar filter.
It relies on the use of a Moving Window Deconvolution (MWD),
as first proposed by Georgiev et al. \cite{mwd}.
It is trivial to obtain a trapezoidal shape from a step input function.
The MWD algorithm works to transform an exponentially decaying pulse into 
a step signal. A step function is undesirable in continous mode of operation
as the pulses form a staircase and eventually saturate. The simple solution
is to perform a subtraction of a delayed sample. This changes the step signal
to a rectangular shape with a length defined by the used delay.
The staircase becomes a train of rectangular pulses.
\autoref{fig:mwd_staircase} shows the consecutive steps of a MWD algorithm.

\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{media/mwd_staircase.png}
  \caption{MWD algorithm applied to a series of 3 pulses}
  \label{fig:mwd_staircase} 
\end{figure}

MWD requires the precise value of the pulse decay constant to
be known. \autoref{fig:mwd_tau} shows the effect of using a wrong value
when configuring the MWD filter. By tuning the filter with a time constant
that is too high an undershoot is obtained after the recatgular shape.
Using a value that is too low causes and overshoot.
Both mistakes reduce the accuracy of pile-up discrimination, 
as consecutive pulses will overlap with the decaying region.

\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{media/mwd_tau.png}
  \caption{The effects of decay constant mismatch between a pulse and a MWD algorithm. Decay constant of pulses is 50 ns.}
  \label{fig:mwd_tau} 
\end{figure}

The MWD algorithm itself produces a rectangular shape. To obtain a trapezoid
an averaging step is applied. This causes the edges to smoothen and as a 
side effect decrease the noise as shown in \autoref{fig:mwd_average}.
The trapezoid filter can also be synthesized using
alternative methods that are better optimized for hardware implementation.
MWD requires division which is an extermely resource consuming operation 
in digital signal processing.

\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{media/mwd_average.png}
  \caption{Last step of synthesizing a trapezoid with the use of MWD}
  \label{fig:mwd_average} 
\end{figure}

\subsection{Triangular filter}

As mentioned earlier the flattop region of a trapezoidal filter
is not particularily useful for pulse detection. By using an 
averaging filter with the same window length as the MWD window, 
the flattop is squeezed and a triangular shape is formed
as shown \autoref{fig:triangular_filter}.
Thus, the triangular filter is a special case of the 
trapezoidal filter that can be used if only detection or timing is of interest.

\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{media/triangular_filter.png}
  \caption{Triangular filter being formed as the last step of a MWD}
  \label{fig:triangular_filter} 
\end{figure}

\subsection{Other solutions}
\subsection{Simulation performance}
